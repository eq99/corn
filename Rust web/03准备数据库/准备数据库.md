# å®‰è£… PostgrsSQL

ï¼ˆ1ï¼‰é…ç½®é•œåƒæº

```shell
ï¼ƒé…ç½®PostgreSQLå®˜æ–¹æº
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
#è…¾è®¯äº‘é•œåƒ
sudo sh -c 'echo "deb https://mirrors.cloud.tencent.com/postgresql/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
#åä¸ºäº‘é•œåƒ
sudo sh -c 'echo "deb https://mirrors.huaweicloud.com/postgresql/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
```

ï¼ˆ2ï¼‰å¯¼å…¥ç­¾åå¯†é’¥ä¸å®‰è£…

```shell
ï¼ƒå¯¼å…¥ç­¾åå¯†é’¥ï¼š
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
ï¼ƒæ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼š
sudo apt-get update
ï¼ƒå®‰è£…PostgreSQL
sudo apt-get -y install postgresql libpq-dev
```

ï¼ˆ3ï¼‰æŸ¥çœ‹æ•°æ®åº“ç‰ˆæœ¬

```shell
psql --version
```

ï¼ˆ4ï¼‰å…è®¸è¿œç¨‹è¿æ¥

é¦–å…ˆé…ç½® `postgresql.conf`

```shell
$ find / -name "postgresql.conf"
/var/lib/pgsql/9.4/data/postgresql.conf
```

æ‰¾åˆ°

```shell
listen_addresses = 'localhost'
```

æ¢æˆï¼š

```shell
listen_addresses = '*'
```

æ¥ç€é…ç½® `pg_hba.conf`ï¼š

åœ¨æœ€åæ·»åŠ ï¼š

```shell
host    all             all              0.0.0.0/0                       md5
host    all             all              ::/0                            md5
```

å‚è€ƒåšå®¢ï¼šhttps://www.bigbinary.com/blog/configure-postgresql-to-allow-remote-connection

# å®‰è£… pgAdmin4

ï¼ˆ1ï¼‰å®‰è£… key:

```shell
sudo curl https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo apt-key add
```

ï¼ˆ2ï¼‰é…ç½®é•œåƒæºï¼š

```shell
# é…ç½®pgAdminå®˜æ–¹æº
sudo sh -c 'echo "deb https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list && apt update'
#è…¾è®¯äº‘é•œåƒ
sudo sh -c 'echo "deb https://mirrors.cloud.tencent.com/postgresql/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list && apt update'
#åä¸ºäº‘é•œåƒ
sudo sh -c 'echo "deb https://mirrors.huaweicloud.com/postgresql/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list && apt update'
```

ï¼ˆ3ï¼‰å®‰è£…:

```shell
# å®‰è£…pgAdmin4(æ¡Œé¢å’ŒwebåŒæ¨¡å¼)
sudo apt install pgadmin4

# å®‰è£…pgAdmin4-desktop(æ¡Œé¢å•æ¨¡å¼)
sudo apt install pgadmin4-desktop

# å®‰è£…pgAdmin4-web(webå•æ¨¡å¼)
sudo apt install pgadmin4-web 
# å¦‚æœå·²å®‰è£…pgadmin4-webå•æ¨¡å¼ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:
sudo /usr/pgadmin4/bin/setup-web.sh
```

å‚è€ƒæ–‡ç« ï¼šhttps://www.huoxiaoqiang.com/basic/sql/3217.html

# PostgreSQL å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                                                         | æè¿°                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| `sudo su - postgres`                                         | åˆ‡æ¢åˆ°æ•°æ®åº“ç”¨æˆ·                                             |
| `psql`                                                       | ç™»å½• PostgreSQL æ§åˆ¶å°                                       |
| `\password postgres`                                         | ä¸º postgres ç”¨æˆ·è®¾ç½®ä¸€ä¸ªå¯†ç                                  |
| `CREATE USER freeoadbuser WITH PASSWORD 'password';`         | åˆ›å»ºæ•°æ®åº“ç”¨æˆ·freeoadbuserï¼Œå¹¶è®¾ç½®å¯†ç                        |
| `CREATE DATABASE freeoadb OWNER freeoadbuser;`               | åˆ›å»ºç”¨æˆ·æ•°æ®åº“ï¼Œè¿™é‡Œä¸ºfreeoadbï¼Œå¹¶æŒ‡å®šæ‰€æœ‰è€…ä¸ºfreeoadbuser   |
| `GRANT ALL PRIVILEGES ON DATABASE freeoadb to freeoadbuser;` | å°†freeoadbæ•°æ®åº“çš„æ‰€æœ‰æƒé™éƒ½èµ‹äºˆfreeoadbuser,å¦åˆ™freeoadbuseråªèƒ½ç™»å½•æ§åˆ¶å°ï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®åº“æ“ä½œæƒé™ |
| `psql -U freeoadbuser -d freeoadb -h 127.0.0.1 -p 5432`      | æ·»åŠ æ–°ç”¨æˆ·å’Œæ–°æ•°æ®åº“ä»¥åï¼Œä»¥æ–°ç”¨æˆ·çš„åä¹‰ç™»å½•æ•°æ®åº“ï¼Œä¼šæç¤ºè¾“å…¥å¯†ç  |
| `\l`                                                         | åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“                                               |
| `\?`                                                         | æŸ¥çœ‹psqlå‘½ä»¤åˆ—è¡¨ã€‚                                           |
| `\c [database_name]`                                         | ä½¿ç”¨æŒ‡å®šæ•°æ®åº“                                               |
| `\d`                                                         | åˆ—å‡ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨æ ¼ã€‚                                   |
| `\d [table_name]`                                            | åˆ—å‡ºæŸä¸€å¼ è¡¨æ ¼çš„ç»“æ„                                         |
| `\du`                                                        | åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·                                                 |
| `\conninfo`                                                  | åˆ—å‡ºå½“å‰æ•°æ®åº“å’Œè¿æ¥çš„ä¿¡æ¯ã€‚                                 |
| ` \i /path/tO/file_name.sql`                                 | æ‰§è¡Œ SQL æ–‡ä»¶                                                |

å‚è€ƒæ–‡ç« ï¼šhttp://www.freeoa.net/osuport/db/postgresql-comm-used-cmd-refer_3072.htmlã€‚



# Postgre SQLè¯­å¥

PostgreSQL æœ‰[å®˜æ–¹æ•™ç¨‹](https://www.postgresqltutorial.com/)ï¼Œè¿™é‡Œæˆ‘ä»¬åªä»‹ç»æ•°æ®åº“è¡¨ç›¸å…³çš„çŸ¥è¯†ï¼Œè¯¦æƒ…è¯·å‚è€ƒå®˜æ–¹æ•™ç¨‹ Section 12ã€‚

## æ•°æ®ç±»å‹

PostgreSQL å¸¸ç”¨çš„å‡ ç§æ•°æ®ç±»å‹å¦‚ä¸‹ï¼š

- å¸ƒå°”ç±»å‹ï¼š`bool`ï¼Œå€¼ï¼š`true, false`
- å­—ç¬¦ç±»å‹ï¼š`varchar(n), text`ï¼›
- æ•´æ•°ï¼š`int`ï¼š-2,147,483,648 to 2,147,483,647
- è‡ªå¢æ•´æ•°ï¼Œå¸¸ç”¨ä½œä¸»é”®ï¼š`serial`ï¼š 1 to 2,147,483,647

- æµ®ç‚¹æ•°ï¼š`real`ï¼š32ä½æµ®ç‚¹æ•°
- æ—¶é—´ï¼š`TIMESTAMP`

[æ›´å¤šç±»å‹è§å®˜ç½‘ã€‚](https://www.postgresqltutorial.com/postgresql-data-types/)

## åˆ›å»ºä¸ä¸¢å¼ƒè¡¨

åˆ›å»ºè¡¨ç¤ºä¾‹ï¼š

```sql
CREATE TABLE accounts (
	user_id serial PRIMARY KEY,
	username VARCHAR ( 50 ) UNIQUE NOT NULL,
	password VARCHAR ( 50 ) NOT NULL,
	email VARCHAR ( 255 ) UNIQUE NOT NULL,
	created_on TIMESTAMP NOT NULL,
    last_login TIMESTAMP 
);

CREATE TABLE roles(
   role_id serial PRIMARY KEY,
   role_name VARCHAR (255) UNIQUE NOT NULL
);

CREATE TABLE account_roles (
  user_id INT NOT NULL,
  role_id INT NOT NULL,
  grant_date TIMESTAMP,
  PRIMARY KEY (user_id, role_id),
  FOREIGN KEY (role_id) REFERENCES roles (role_id),
  FOREIGN KEY (user_id) REFERENCES accounts (user_id),
);

CREATE TABLE wallet (
	user_id INT UNIQUE FOREIGN KEY REFERENCES accounts(user_id) ON DELETE CASCADE,
    balance: real DEFAULT 0.0 NOT NULL
)


ALTER TABLE child_table
ADD CONSTRAINT constraint_fk
FOREIGN KEY (fk_columns)
REFERENCES parent_table(parent_key_columns)
ON DELETE CASCADE;
```

ğŸ“ è¦ç‚¹è§£è¯»ï¼š

- ä»¥ä¸Šä¾‹å­æ­ç¤ºäº†ï¼šä¸»é”®å®šä¹‰ï¼Œéç©ºçº¦æŸï¼Œå”¯ä¸€æ€§çº¦æŸï¼Œ[å¤–é”®çº¦æŸ](https://www.postgresqltutorial.com/postgresql-foreign-key/)ã€‚
- `wallet` ä¾‹å­æ­ç¤ºäº†ä¸€å¯¹ä¸€å…³ç³»ï¼Œå¤–é”®å®šä¹‰çš„å¦ä¸€ç§æ–¹æ³•ï¼Œä»¥åŠå¤–é”®åˆ é™¤æ“ä½œï¼Œ[å¤–é”®çº¦æŸ StarkOverFlow å›ç­”](https://stackoverflow.com/a/28560619/17225183)ã€‚
- PostgreSQL ä¼šä¸ºä¸»é”®ï¼Œunique çº¦æŸçš„åˆ—è‡ªåŠ¨[åˆ›å»ºç´¢å¼•](https://www.postgresqltutorial.com/postgresql-indexes/postgresql-create-index/)ã€‚

ä¸¢å¼ƒè¡¨ç¤ºä¾‹ï¼š

```sql
DROP TABLE IF EXISTS roles;
```

## ä¿®æ”¹è¡¨

ğŸ”‘ å¢åŠ æˆ–å‡å°‘åˆ—ï¼š

```sql
ALTER TABLE table_name 
ADD COLUMN column_name datatype column_constraint;

ALTER TABLE table_name 
DROP COLUMN column_name;
```

ğŸ”‘ é‡å‘½åï¼š

```sql
ALTER TABLE IF EXISTS table_name
RENAME TO new_table_name;

ALTER TABLE table_name 
RENAME COLUMN column_name TO new_column_name;
```

ğŸ”‘ ä¿®æ”¹çº¦æŸï¼š

```sql
ALTER TABLE table_name 
ALTER COLUMN column_name 
[SET DEFAULT value | DROP DEFAULT];

ALTER TABLE table_name 
ALTER COLUMN column_name 
[SET NOT NULL| DROP NOT NULL];


ALTER TABLE table_name 
ADD CONSTRAINT constraint_name constraint_definition;

ALTER TABLE table_name DROP CONSTRAINT constraint_name;

```

ğŸ”‘ ä¿®æ”¹åˆ—ç±»å‹ï¼š

```sql
ALTER TABLE table_name
ALTER COLUMN column_name TYPE new_data_type USING expression;
```

ğŸ“ è¦ç‚¹è§£è¯»ï¼š

- ç»†å¿ƒçš„è¯»è€…å·²ç»å‘ç°äº†æˆ‘ä»¬åšçš„ä¿®æ”¹æ˜¯æˆå¯¹çš„ï¼Œè¿™æ˜¯æœ‰æ„å®‰æ’æˆè¿™æ ·çš„ã€‚å¦‚æœç†Ÿæ‚‰ Django ORMï¼Œä½ ä¼šå‘ç° Django ORM çš„ migrate åŠŸèƒ½éå¸¸å¥½ç”¨ï¼Œç”±äº Rust è¯­è¨€è¿˜æ²¡æœ‰å¦‚æ­¤å¼ºå¤§çš„ ORMï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å®Œæˆè¿™äº›å·¥ä½œã€‚

# å®‰è£… Diesel CLI(é€‰åš)

[Diesel](https://diesel.rs/) æ˜¯ Rust è¯­è¨€çš„ ORM åº“ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ï¼Œç°åœ¨æˆ‘ä»¬åœ¨ Windows 10 ä¸Šå®‰è£…å®ƒçš„ cli å·¥å…·ã€‚

ğŸ”‘ ä» https://www.enterprisedb.com/download-postgresql-binaries ä¸‹è½½ç›¸åº”çš„åŒ…ï¼Œè§£å‹å¤‡ç”¨ã€‚

ğŸ”‘ æ‰“å¼€ `cmd` ï¼Œè¿è¡Œï¼š

```shell
$ set PQ_LIB_DIR=C:\Program Files\PostgreSQL\14\lib
$ cargo install diesel_cli --no-default-features --features postgres
```

æ³¨æ„é‚£ä¸ªè·¯å¾„è¦æ¢æˆä½ è‡ªå·±çš„ã€‚

ğŸ”‘ ä»ä¸‹è½½çš„ `PostgreSQL\bin` ç›®å½•ä¸­æ‹·è´å¦‚ä¸‹å‡ ä¸ªæ–‡ä»¶åˆ°ï¼š`$HOME\.cargo\bin` ä¸­ï¼š

```shell
# https://github.com/diesel-rs/diesel/issues/1883#issuecomment-583946727
libcrypto-1_1.dll
libiconv-2.dll
libintl-8.dll
libpq.dll
libssl-1_1.dll
```

ğŸ”‘ æœ€åè¿è¡Œæµ‹è¯•ï¼š

```shell
$ diesel
```

å‚è€ƒæ–‡ç« ï¼š

ï¼ˆ1ï¼‰https://blog.51cto.com/u_15060533/4112387

ï¼ˆ2ï¼‰https://luckystreak.ca/writing/fixing_diesel_cli_rust_build_error.html

# ä½¿ç”¨ sea-orm

ç”±äºè‡ªå·±å¯¹ Django æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæ‰€ä»¥æ‰“ç®—ä½¿ç”¨ç±»ä¼¼çš„ ORM æ¡†æ¶ï¼Œsea-orm è¿˜å¤„äºé€ è½®å­é˜¶æ®µï¼Œå¾ˆå¤šåŠŸèƒ½è¿˜æ²¡å¼€å‘å®Œæˆï¼Œå…¶ä¸­æœ€å¥½ç”¨çš„æ•°æ®åº“è¿ç§»åŠŸèƒ½è¿˜æ²¡å®Œæˆï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ `sqlx-cli` è¿‡æ¸¡ã€‚

ğŸ”‘ å®‰è£…

```shell
# only for postgres
$ cargo install sqlx-cli --no-default-features --features postgres

# supports all databases supported by SQLx
$ cargo install sqlx-cli
```

ğŸ”‘ åœ¨é¡¹ç›®æ ¹ç›®å½•æ·»åŠ  `.env` æ–‡ä»¶ï¼Œåœ¨é‡Œé¢æ·»åŠ ï¼š

```shell
# Postgres
DATABASE_URL=postgres://postgres@localhost/my_database
```

ğŸ”‘ æ–°å»ºæ•°æ®åº“

```shell
sqlx database create
sqlx database drop
```

ğŸ”‘ åˆ›å»ºç¬¬ä¸€ä¸ª migrate

```shell
$ sqlx migrate add -r create_user
Creating migrations/20211001154420_<create_user>.up.sql
Creating migrations/20211001154420_<create_user>.down.sql
```

åœ¨ `migrations/20211001154420_<create_user>.up.sql` æ·»åŠ 

```sql
CREATE TABLE users (
	users_id serial PRIMARY KEY,
	nickname VARCHAR ( 50 ) UNIQUE NOT NULL,
    avatar VARCHAR (255),
    reputation INT DEFAULT 0
);
```

åœ¨ `migrations/20211001154420_<create_user>.down.sql` æ·»åŠ ï¼š

```sql
DROP TABLE IF EXISTS users;
```

æ‰§è¡Œï¼š

```shell
$ sqlx migrate run # up
$ sqlx migrate revert # down
```

âš ï¸ ç”¨æˆ·åä¸è¦ç”¨ `user, group` ï¼Œè¿™ä¸ªå¥½åƒæ˜¯ä¿ç•™å­—ã€‚

ğŸ”‘  é€šè¿‡ `sea-orm-cli` ç”Ÿæˆå®ä½“ï¼ˆentityï¼‰:

```shell
cargo install sea-orm-cli

# Generate entity files of database to `src/entity`
$ sea-orm-cli generate entity -o src/entity
```







